<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Seguimiento Vehicular</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
body {
  margin: 0;
  font-family: Arial, Helvetica, sans-serif;
  background: #0b132b;
  color: white;
}
#map {
  height: 100vh;
  width: 100vw;
}
.status {
  position: absolute;
  top: 10px;
  left: 10px;
  background: rgba(0,0,0,0.75);
  padding: 10px;
  border-radius: 8px;
  z-index: 1000;
  font-size: 14px;
}
</style>
</head>

<body>

<div id="map"></div>
<div class="status" id="status">üöó Esperando datos GPS...</div>

<script>
// ================= CONFIG =================
const POSITION_URL =
  "https://raw.githubusercontent.com/KVMS14/vehicle-traker/main/position.json";
const POLL_INTERVAL = 3000;

// ================= MAP ====================
const map = L.map('map').setView([0, 0], 16);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution: '¬© OpenStreetMap'
}).addTo(map);

let marker = null;
let path = L.polyline([], { color: 'red' }).addTo(map);

let lastLat = null;
let lastLon = null;
let lastTracking = false;

// ================= POLLING =================
async function pollPosition() {
  try {
    const res = await fetch(
      POSITION_URL + "?ts=" + Date.now()
    );
    if (!res.ok) return;

    const data = await res.json();

    const lat = data.lat;
    const lon = data.lon;
    const tracking = data.tracking;
    const time = data.time;

    if (lat === undefined || lon === undefined) return;

    // üî¥ Tracking detenido
    if (!tracking) {
      if (lastTracking) {
        path.setLatLngs([]);
        lastLat = null;
        lastLon = null;
        document.getElementById("status").innerHTML =
          "‚õî Seguimiento detenido";
      }
      lastTracking = false;
      return;
    }

    // üü¢ Nuevo tracking iniciado
    if (!lastTracking && tracking) {
      path.setLatLngs([]);
      marker = null;
    }

    const latLng = [lat, lon];

    if (!marker) {
      marker = L.marker(latLng).addTo(map);
      map.setView(latLng, 18);
    } else {
      marker.setLatLng(latLng);
    }

    path.addLatLng(latLng);

    document.getElementById("status").innerHTML =
      "üöó VEH√çCULO EN MOVIMIENTO<br>" +
      "LAT: " + lat.toFixed(6) + "<br>" +
      "LON: " + lon.toFixed(6) + "<br>" +
      "‚è±Ô∏è " + new Date(time * 1000).toLocaleTimeString();

    lastLat = lat;
    lastLon = lon;
    lastTracking = true;

  } catch (e) {
    console.error("Polling error:", e);
  }
}

// ================= LOOP ====================
setInterval(pollPosition, POLL_INTERVAL);
</script>

</body>
</html>
